
@inject IJSRuntime JsRuntime
@inject TextHub.Services.Data.ToolDataService ToolDataService
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Components.Web
<nav class="sticky top-0 z-50 bg-background/80 backdrop-blur-md border-b border-border" role="navigation" aria-label="Main navigation">
        <div class="container mx-auto px-4 py-3 md:py-4">
            <div class="flex items-center justify-between">
                <a class="text-xl md:text-2xl font-bold text-gradient hover:opacity-80 transition-opacity" href="/" aria-label="Text Hub - Home">Text Hub</a>

                @* --- Desktop Menu --- *@
                <div class="hidden md:flex items-center gap-6" role="menubar">
                    <NavLink class="nav-link" href="" Match="NavLinkMatch.All" role="menuitem">Home</NavLink>
                    <div class="relative">
                        <button @onclick="() => _isToolsDropdownOpen = !_isToolsDropdownOpen" @onclick:stopPropagation="true" type="button" class="flex items-center gap-1 font-medium hover:text-primary transition-colors cursor-pointer" aria-expanded="@_isToolsDropdownOpen" aria-haspopup="true" role="menuitem">
                            Tools
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down w-4 h-4 transition-transform @(_isToolsDropdownOpen ? "rotate-180" : "")" aria-hidden="true">
                                <path d="m6 9 6 6 6-6"></path>
                            </svg>
                        </button>
                        @if (_isToolsDropdownOpen)
                        {
                            <div id="tools-dropdown" @onclick:stopPropagation="true" @onclick:preventDefault="true" class="absolute top-full mt-2 w-72 p-2 bg-popover text-popover-foreground border border-border rounded-md shadow-md z-50" role="menu" aria-label="Tools menu">
                                @* Text Case Tools Section *@
                                <div class="mb-1">
                                    <button @onclick="() => ToggleTextCaseSection()" type="button" class="flex items-center justify-between w-full px-2 py-1.5 text-sm font-semibold text-muted-foreground hover:text-foreground transition-colors rounded hover:bg-muted/50">
                                        Text Case Tools
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down w-4 h-4 transition-transform @(_isTextCaseOpen ? "rotate-180" : "")">
                                            <path d="m6 9 6 6 6-6"></path>
                                        </svg>
                                    </button>
                                    @if (_isTextCaseOpen)
                                    {
                                        <div class="ml-2 mt-1">
                                            @foreach (var tool in ToolDataService.GetTextCaseTools().Where(t => !t.IsComingSoon).Take(8))
                                            {
                                                <a @onclick="() => NavigateToTool(tool.Href)" class="relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground flex items-center gap-3 cursor-pointer">
                                                    @((MarkupString)tool.Icon.Replace("w-6 h-6", "w-4 h-4"))
                                                    @tool.Title
                                                </a>
                                            }
                                        </div>
                                    }
                                </div>

                                @* Text Analysis Section *@
                                <div class="mb-1">
                                    <button @onclick="() => ToggleTextAnalysisSection()" type="button" class="flex items-center justify-between w-full px-2 py-1.5 text-sm font-semibold text-muted-foreground hover:text-foreground transition-colors rounded hover:bg-muted/50">
                                        Text Analysis
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down w-4 h-4 transition-transform @(_isTextAnalysisOpen ? "rotate-180" : "")">
                                            <path d="m6 9 6 6 6-6"></path>
                                        </svg>
                                    </button>
                                    @if (_isTextAnalysisOpen)
                                    {
                                        <div class="ml-2 mt-1">
                                            @foreach (var tool in ToolDataService.GetTextAnalysisTools().Where(t => !t.IsComingSoon).Take(3))
                                            {
                                                <a @onclick="() => NavigateToTool(tool.Href)" class="relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground flex items-center gap-3 cursor-pointer">
                                                    @((MarkupString)tool.Icon.Replace("w-6 h-6", "w-4 h-4"))
                                                    @tool.Title
                                                </a>
                                            }
                                        </div>
                                    }
                                </div>

                                @* Text Formatting Section *@
                                <div class="mb-1">
                                    <button @onclick="() => ToggleTextFormattingSection()" type="button" class="flex items-center justify-between w-full px-2 py-1.5 text-sm font-semibold text-muted-foreground hover:text-foreground transition-colors rounded hover:bg-muted/50">
                                        Text Formatting
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down w-4 h-4 transition-transform @(_isTextFormattingOpen ? "rotate-180" : "")">
                                            <path d="m6 9 6 6 6-6"></path>
                                        </svg>
                                    </button>
                                    @if (_isTextFormattingOpen)
                                    {
                                        <div class="ml-2 mt-1">
                                            @foreach (var tool in ToolDataService.GetTextFormattingTools().Where(t => !t.IsComingSoon).Take(4))
                                            {
                                                <a @onclick="() => NavigateToTool(tool.Href)" class="relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground flex items-center gap-3 cursor-pointer">
                                                    @((MarkupString)tool.Icon.Replace("w-6 h-6", "w-4 h-4"))
                                                    @tool.Title
                                                </a>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                    <NavLink class="nav-link" href="documentation">Docs</NavLink>
                    <button @onclick="ToggleTheme" class="p-2 rounded-lg hover:bg-muted transition-colors" aria-label="Toggle dark mode">
                        @if (_isDarkMode)
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun w-5 h-5 text-primary"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon w-5 h-5 text-primary"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                        }
                    </button>
                </div>

                @* --- Mobile Menu Button --- *@
                <div class="flex md:hidden items-center gap-2">
                    <button @onclick="ToggleTheme" class="p-2 rounded-lg hover:bg-muted transition-colors" aria-label="Toggle dark mode">
                        @if (_isDarkMode)
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun w-5 h-5 text-primary"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon w-5 h-5 text-primary"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                        }
                    </button>
                    <button @onclick="ToggleMobileMenu" class="p-2 rounded-lg hover:bg-muted transition-colors" aria-label="Open menu" type="button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu w-5 h-5"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg>
                    </button>
                </div>
            </div>
             @* --- Mobile Menu Panel (hidden by default) --- *@
            @if (_isMobileMenuOpen)
            {
                <div class="md:hidden mt-4">
                    <a href="" class="block py-2 text-lg nav-link">Home</a>
                    <a href="#tools" class="block py-2 text-lg nav-link">Tools</a>
                    <a href="documentation" class="block py-2 text-lg nav-link">Documentation</a>
                </div>
            }
        </div>
    </nav>

@code
{
    private bool _isMobileMenuOpen;
    private bool _isToolsDropdownOpen;
    private bool _isTextCaseOpen = false;
    private bool _isTextAnalysisOpen = false;
    private bool _isTextFormattingOpen = false;
    private bool _isDarkMode = false; // Will be initialized from localStorage

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Initialize theme from localStorage or system preference
            _isDarkMode = await JsRuntime.InvokeAsync<bool>("getTheme");
            
            // Setup click outside handler for dropdown
            await JsRuntime.InvokeVoidAsync("setupClickOutside", "tools-dropdown", DotNetObjectReference.Create(this));
            
            StateHasChanged();
        }
    }

    private void ToggleMobileMenu()
    {
        _isMobileMenuOpen = !_isMobileMenuOpen;
    }
    
    private async Task ToggleTheme()
    {
        _isDarkMode = !_isDarkMode;
        await JsRuntime.InvokeVoidAsync("toggleTheme", _isDarkMode);
        StateHasChanged();
    }

    [JSInvokable]
    public void CloseDropdown()
    {
        _isToolsDropdownOpen = false;
        _isTextCaseOpen = false;
        _isTextAnalysisOpen = false;
        _isTextFormattingOpen = false;
        StateHasChanged();
    }

    private void NavigateToTool(string href)
    {
        // Close the dropdown first
        CloseDropdown();
        
        // Navigate to the tool
        Navigation.NavigateTo(href);
    }

    private void ToggleTextCaseSection()
    {
        // Close other sections and toggle this one
        _isTextAnalysisOpen = false;
        _isTextFormattingOpen = false;
        _isTextCaseOpen = !_isTextCaseOpen;
        StateHasChanged();
    }

    private void ToggleTextAnalysisSection()
    {
        // Close other sections and toggle this one
        _isTextCaseOpen = false;
        _isTextFormattingOpen = false;
        _isTextAnalysisOpen = !_isTextAnalysisOpen;
        StateHasChanged();
    }

    private void ToggleTextFormattingSection()
    {
        // Close other sections and toggle this one
        _isTextCaseOpen = false;
        _isTextAnalysisOpen = false;
        _isTextFormattingOpen = !_isTextFormattingOpen;
        StateHasChanged();
    }
}
